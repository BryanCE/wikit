# Task 2.4: Create MCP Server Code

## Purpose

Implement the complete MCP server with tool handlers that call wikit commands.

## Update src/server.ts

Replace the placeholder from Task 2.2 with the full implementation:

```typescript
import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";
import {
  ListToolsRequestSchema,
  CallToolRequestSchema,
} from "@modelcontextprotocol/sdk/types.js";

// Import wikit commands
import {
  listPages,
  getPageContent,
  getNavigation,
  getStatus,
} from "@bryance/wikit/commands";
import type { WikiConfig } from "@bryance/wikit/types";

export async function createMCPServer(config: WikiConfig) {
  const server = new Server(
    {
      name: "wikit-mcp",
      version: "0.1.0",
    },
    {
      capabilities: {
        tools: {},
      },
    }
  );

  // List available tools
  server.setRequestHandler(ListToolsRequestSchema, async () => {
    return {
      tools: [
        {
          name: "search_wiki_pages",
          description:
            "Search for pages in Wiki.js instance by title or content",
          inputSchema: {
            type: "object",
            properties: {
              query: {
                type: "string",
                description: "Search query for page titles or content",
              },
              instance: {
                type: "string",
                enum: ["primary", "secondary", "both"],
                description: "Which wiki instance to search",
                default: "primary",
              },
            },
            required: ["query"],
          },
        },
        {
          name: "get_page_content",
          description: "Get the full content of a specific wiki page",
          inputSchema: {
            type: "object",
            properties: {
              pageId: {
                type: "number",
                description: "The ID of the page to retrieve",
              },
              instance: {
                type: "string",
                enum: ["primary", "secondary"],
                description: "Which wiki instance",
                default: "primary",
              },
            },
            required: ["pageId"],
          },
        },
        {
          name: "list_navigation",
          description: "Get the navigation tree/structure of the wiki",
          inputSchema: {
            type: "object",
            properties: {
              instance: {
                type: "string",
                enum: ["primary", "secondary"],
                description: "Which wiki instance",
                default: "primary",
              },
            },
          },
        },
        {
          name: "get_wiki_status",
          description:
            "Get status information about the wiki instance (version, stats, etc)",
          inputSchema: {
            type: "object",
            properties: {
              instance: {
                type: "string",
                enum: ["primary", "secondary", "both"],
                description: "Which wiki instance",
                default: "both",
              },
            },
          },
        },
      ],
    };
  });

  // Handle tool calls
  server.setRequestHandler(CallToolRequestSchema, async (request) => {
    const { name, arguments: args } = request.params;

    try {
      switch (name) {
        case "search_wiki_pages": {
          const results = await listPages({
            instance: args.instance || "primary",
            search: args.query,
          });
          return {
            content: [
              {
                type: "text",
                text: JSON.stringify(results, null, 2),
              },
            ],
          };
        }

        case "get_page_content": {
          const page = await getPageContent({
            pageId: args.pageId,
            instance: args.instance || "primary",
          });
          return {
            content: [
              {
                type: "text",
                text: JSON.stringify(page, null, 2),
              },
            ],
          };
        }

        case "list_navigation": {
          const nav = await getNavigation({
            instance: args.instance || "primary",
          });
          return {
            content: [
              {
                type: "text",
                text: JSON.stringify(nav, null, 2),
              },
            ],
          };
        }

        case "get_wiki_status": {
          const status = await getStatus({
            instance: args.instance || "both",
          });
          return {
            content: [
              {
                type: "text",
                text: JSON.stringify(status, null, 2),
              },
            ],
          };
        }

        default:
          throw new Error(`Unknown tool: ${name}`);
      }
    } catch (error) {
      return {
        content: [
          {
            type: "text",
            text: `Error: ${
              error instanceof Error ? error.message : String(error)
            }`,
          },
        ],
        isError: true,
      };
    }
  });

  return server;
}
```

## How It Works

### 1. Tool Registration (ListToolsRequestSchema)

This handler tells MCP clients what tools are available:
- Tool name (e.g., `search_wiki_pages`)
- Description for AI to understand when to use it
- Input schema (what parameters it accepts)

### 2. Tool Execution (CallToolRequestSchema)

This handler actually executes the tools:
- Receives tool name and arguments
- Calls the appropriate wikit command
- Returns results as JSON text
- Handles errors gracefully

### 3. Tool Implementations

Each tool:
1. Extracts arguments from the request
2. Calls a function from `@bryance/wikit/commands`
3. Returns the result in MCP format
4. Catches and formats errors

## The 4 Tools

1. **search_wiki_pages** - Search by query
   - Calls: `listPages({ instance, search })`
   - Returns: Array of matching pages

2. **get_page_content** - Get full page
   - Calls: `getPageContent({ pageId, instance })`
   - Returns: Page object with content

3. **list_navigation** - Get nav tree
   - Calls: `getNavigation({ instance })`
   - Returns: Navigation structure

4. **get_wiki_status** - Get status info
   - Calls: `getStatus({ instance })`
   - Returns: Wiki instance status

## Error Handling

Each tool call is wrapped in try/catch:
- Successful: Returns data in `content` array
- Failed: Returns error message with `isError: true`

## Verification

- [ ] All imports from @bryance/wikit work
- [ ] 4 tools defined in ListToolsRequestSchema
- [ ] 4 tool handlers in CallToolRequestSchema
- [ ] Error handling for each tool
- [ ] No TypeScript errors

## Next Steps

Move to Task 2.5 to create the TypeScript configuration for the MCP server.
